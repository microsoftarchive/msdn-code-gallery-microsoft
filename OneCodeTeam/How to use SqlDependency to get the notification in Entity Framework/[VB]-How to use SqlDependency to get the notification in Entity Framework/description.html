<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="https://i-msdn.sec.s-msft.com/Combined.css?resources=0:Header,0:HeaderFooterSprite,0:Header.NonMtps;/Areas/Centers/Themes/StandardDevCenter/Content:0&amp;amp;v=23E9A5CBC52062E31AE45157B970504B" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="https://i-msdn.sec.s-msft.com/Combined.css?resources=0:Footer,0:HeaderFooterSprite,0:Footer.NonMtps,1:NewFooterSock,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;v=779C1C1BECDB79910DE087040C45EE9E" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>How to use SqlDependency to get the notification in Entity Framework</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" />
        <link href="https://i1.code.msdn.s-msft.com/content/common/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="https://i1.code.msdn.s-msft.com/content/common/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>How to use SqlDependency to get the notification in Entity Framework</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            ADO.NET, Data Access, Entity Framework, .NET Development
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            Entity Frameowork, Sqldependency, automatically update
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Data
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary language</label>
                    <div id="LastUpdated">en-US</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Updated</label>
                    <div id="LastUpdated">8/17/2016</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">Apache License, Version 2.0</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="https://code.msdn.microsoft.com/How-to-use-SqlDependency-f4b8eb43">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    
<hr>
<div><a href="http://blogs.msdn.com/b/onecode" style="margin-top:3px"><img src="http://bit.ly/onecodesampletopbanner" alt="">
</a></div>
<h1>How to Automatically Update Data by Sqldependency in Entity Framework (VBEFAutoUpdate)</h1>
<h2>Introduction</h2>
<p class="MsoNormal">We can use the Sqldependency to get the notification when the data is changed in database, but EF doesn't have the same feature. In this sample, we will demonstrate how to automatically update by Sqldependency in Entity Framework.</p>
<p class="MsoNormal">In this sample, we will demonstrate two ways that use SqlDependency to get the change notification to auto update data:</p>
<p class="MsoNormal">1. Get the notification of changes immediately.</p>
<p class="MsoNormal">2. Get the notification of changes regularly.</p>
<p class="MsoNormal"><strong>Note</strong> For C# version, you can go to&nbsp;<a href="https://code.msdn.microsoft.com/How-to-use-SqlDependency-f4b8eb43/https://code.msdn.microsoft.com/How-to-use-SqlDependency-5c0da0b3">https://code.msdn.microsoft.com/How-to-use-SqlDependency-f4b8eb43/https://code.msdn.microsoft.com/How-to-use-SqlDependency-5c0da0b3</a> to download.</p>
<h2>Building the Sample</h2>
<p class="MsoNormal">Before you run the sample, you need to finish the following step:</p>
<p class="MsoNormal">Step1. Modify the connection string in the App.config-&gt; &lt;configuration&gt;-&gt; &lt;connectionStrings&gt; to your SQL Server 2008 database instance.</p>
<h2>Running the Sample</h2>
<p class="MsoNormal">Press F5 to run the sample, the following is the result.</p>
<p class="MsoNormal"><span><img src="description/image.png" alt="" width="756" height="452" align="middle">
</span></p>
<p class="MsoNormal"><strong>1. Immediately Update </strong></p>
<p class="MsoNormal"><span>First, input the range of price to get the products, or you can directly click the
<strong><em>Get Data</em></strong> button to get all the products. </span></p>
<p class="MsoNormal"><span>&nbsp;</span><span> <img src="description/a19c3ab6-a4fa-4dbe-9cf6-8414fcaa253fimage.png" alt="" width="756" height="452" align="middle">
</span></p>
<p class="MsoNormal">Second, you can click the cell in DataGridView to select the product or just input the id in
<strong><em>Product Id</em></strong>, and then input the new price. After click the
<strong><em>Update</em></strong> button, the value in DataGridView will update.</p>
<p class="MsoNormal"><span><img src="description/0bf59157-ee3e-4d04-a259-02de542f3f0cimage.png" alt="" width="756" height="452" align="middle">
</span></p>
<p class="MsoNormal">At finally, you can click <strong><em>Stop</em></strong> button to stop the Update.</p>
<p class="MsoNormal"><strong>2. Regularly Update </strong></p>
<p class="MsoNormal">First, input the range of price to get the products and input the seconds to set the period of update.</p>
<p class="MsoNormal"><span><img src="description/1f8556fe-7ce1-43e2-ac60-e14dd01d97e7image.png" alt="" width="756" height="452" align="middle">
</span></p>
<p class="MsoNormal">Then you can input the new price and update. The value will be updated at the end of the period.</p>
<p class="MsoNormal"><span><img src="description/08cd7f50-3772-48b4-b251-e4be1ad0c2ebimage.png" alt="" width="756" height="452" align="middle">
</span></p>
<h2>Using the Code</h2>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
0.<strong> Start/Stop the monitor</strong></p>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
We need a global location, to start/stop the sql dependency monitor activity for each DbContext. In this sample, we make use of form &quot;On Load&quot; and &quot;Form Closed&quot; event to put the codes.</p>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
&nbsp;</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>VB Script</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">vbs</span>
<pre class="hidden">Private Sub AutoUpdate_Load(ByVal sender As Object, ByVal e As EventArgs) Handles MyBase.Load
	btnGetData.Enabled = CanRequestNotifications()

	CreateDatabaseIfNotExist()

	' start notification monitor
	ImmediateNotificationRegister(Of Product).StartMonitor(warehouse)
	RegularlyNotificationRegister(Of Product).StartMonitor(warehouse)
End Sub

Private Sub AutoUpdate_FormClosed(sender As Object, e As FormClosedEventArgs) Handles MyBase.FormClosed
	' stop notification monitor
	ImmediateNotificationRegister(Of Product).StopMonitor(warehouse)
	RegularlyNotificationRegister(Of Product).StopMonitor(warehouse)
End Sub
</pre>
<div class="preview">
<pre class="vbs"><span class="vbScript__keyword">Private</span>&nbsp;<span class="vbScript__keyword">Sub</span>&nbsp;AutoUpdate_Load(<span class="vbScript__keyword">ByVal</span>&nbsp;sender&nbsp;<span class="vbScript__keyword">As</span>&nbsp;<span class="vbScript__keyword">Object</span>,&nbsp;<span class="vbScript__keyword">ByVal</span>&nbsp;e&nbsp;<span class="vbScript__keyword">As</span>&nbsp;EventArgs)&nbsp;<span class="vbScript__keyword">Handles</span>&nbsp;<span class="vbScript__keyword">MyBase</span>.Load&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;btnGetData.Enabled&nbsp;=&nbsp;CanRequestNotifications()&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;CreateDatabaseIfNotExist()&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="vbScript__com">'&nbsp;start&nbsp;notification&nbsp;monitor</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;ImmediateNotificationRegister(<span class="vbScript__keyword">Of</span>&nbsp;Product).StartMonitor(warehouse)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;RegularlyNotificationRegister(<span class="vbScript__keyword">Of</span>&nbsp;Product).StartMonitor(warehouse)&nbsp;
<span class="vbScript__keyword">End</span>&nbsp;<span class="vbScript__keyword">Sub</span>&nbsp;
&nbsp;
<span class="vbScript__keyword">Private</span>&nbsp;<span class="vbScript__keyword">Sub</span>&nbsp;AutoUpdate_FormClosed(sender&nbsp;<span class="vbScript__keyword">As</span>&nbsp;<span class="vbScript__keyword">Object</span>,&nbsp;e&nbsp;<span class="vbScript__keyword">As</span>&nbsp;FormClosedEventArgs)&nbsp;<span class="vbScript__keyword">Handles</span>&nbsp;<span class="vbScript__keyword">MyBase</span>.FormClosed&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="vbScript__com">'&nbsp;stop&nbsp;notification&nbsp;monitor</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;ImmediateNotificationRegister(<span class="vbScript__keyword">Of</span>&nbsp;Product).StopMonitor(warehouse)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;RegularlyNotificationRegister(<span class="vbScript__keyword">Of</span>&nbsp;Product).StopMonitor(warehouse)&nbsp;
<span class="vbScript__keyword">End</span>&nbsp;<span class="vbScript__keyword">Sub</span>&nbsp;
</pre>
</div>
</div>
</div>
<div class="endscriptcode"></div>
<div class="endscriptcode">1. <strong>Get the ObjectQuery</strong></div>
<p>&nbsp;</p>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
We need the connection string, command string and parameters to create the SqlDependency, so we need to get the ObjectQuery. If we use DbQuery to query, we first convert the DbQuery to ObjectQuery.</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>VB</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">vb</span>
<pre class="hidden">Public Shared Function GetObjectQuery(Of TEntity As Class)(ByVal Context As DbContext, ByVal query As IQueryable) As ObjectQuery
&nbsp;&nbsp;&nbsp; If TypeOf query Is ObjectQuery Then
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return TryCast(query, ObjectQuery)
&nbsp;&nbsp;&nbsp; End If


&nbsp;&nbsp;&nbsp; If Context Is Nothing Then
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Throw New ArgumentException(&quot;Paramter cannot be null&quot;, &quot;context&quot;)
&nbsp;&nbsp;&nbsp; End If


&nbsp;&nbsp;&nbsp; ' Use the DbContext to create the ObjectContext
&nbsp;&nbsp;&nbsp; Dim objectContext As ObjectContext = (CType(Context, IObjectContextAdapter)).ObjectContext
&nbsp;&nbsp;&nbsp; ' Use the DbSet to create the ObjectSet and get the appropriate provider.
&nbsp;&nbsp;&nbsp; Dim iqueryable As IQueryable = TryCast(objectContext.CreateObjectSet(Of TEntity)(), IQueryable)
&nbsp;&nbsp;&nbsp; Dim provider As IQueryProvider = iqueryable.Provider


&nbsp;&nbsp;&nbsp; ' Use the provider and expression to create the ObjectQuery.
&nbsp;&nbsp;&nbsp; Return TryCast(provider.CreateQuery(query.Expression), ObjectQuery)
End Function

</pre>
<pre id="codePreview" class="vb">Public Shared Function GetObjectQuery(Of TEntity As Class)(ByVal Context As DbContext, ByVal query As IQueryable) As ObjectQuery
&nbsp;&nbsp;&nbsp; If TypeOf query Is ObjectQuery Then
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return TryCast(query, ObjectQuery)
&nbsp;&nbsp;&nbsp; End If


&nbsp;&nbsp;&nbsp; If Context Is Nothing Then
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Throw New ArgumentException(&quot;Paramter cannot be null&quot;, &quot;context&quot;)
&nbsp;&nbsp;&nbsp; End If


&nbsp;&nbsp;&nbsp; ' Use the DbContext to create the ObjectContext
&nbsp;&nbsp;&nbsp; Dim objectContext As ObjectContext = (CType(Context, IObjectContextAdapter)).ObjectContext
&nbsp;&nbsp;&nbsp; ' Use the DbSet to create the ObjectSet and get the appropriate provider.
&nbsp;&nbsp;&nbsp; Dim iqueryable As IQueryable = TryCast(objectContext.CreateObjectSet(Of TEntity)(), IQueryable)
&nbsp;&nbsp;&nbsp; Dim provider As IQueryProvider = iqueryable.Provider


&nbsp;&nbsp;&nbsp; ' Use the provider and expression to create the ObjectQuery.
&nbsp;&nbsp;&nbsp; Return TryCast(provider.CreateQuery(query.Expression), ObjectQuery)
End Function

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
2. <strong>Immediately Update</strong></p>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
Before start the SqlDependency, stop all the SqlDependency.</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>VB</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">vb</span>
<pre class="hidden">Private Sub BeginSqlDependency()
&nbsp;&nbsp;&nbsp; ' Before start the SqlDependency, stop all the SqlDependency.
&nbsp;&nbsp;&nbsp; SqlDependency.Stop(QueryExtension.GetConnectionString(objectQuery))
&nbsp;&nbsp;&nbsp; SqlDependency.Start(QueryExtension.GetConnectionString(objectQuery))


&nbsp;&nbsp;&nbsp; RegisterSqlDependency()
End Sub

</pre>
<pre id="codePreview" class="vb">Private Sub BeginSqlDependency()
&nbsp;&nbsp;&nbsp; ' Before start the SqlDependency, stop all the SqlDependency.
&nbsp;&nbsp;&nbsp; SqlDependency.Stop(QueryExtension.GetConnectionString(objectQuery))
&nbsp;&nbsp;&nbsp; SqlDependency.Start(QueryExtension.GetConnectionString(objectQuery))


&nbsp;&nbsp;&nbsp; RegisterSqlDependency()
End Sub

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
Then register the SqlDependency.</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>VB</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">vb</span>
<pre class="hidden">Private Sub RegisterSqlDependency()
&nbsp;&nbsp;&nbsp; If Command Is Nothing OrElse Connection Is Nothing Then
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Throw New ArgumentException(&quot;command and connection cannot be null&quot;)
&nbsp;&nbsp;&nbsp; End If


&nbsp;&nbsp;&nbsp; ' Make sure the command object does not already have
&nbsp;&nbsp;&nbsp; ' a notification object associated with it.
&nbsp;&nbsp;&nbsp; cmd.Notification = Nothing


&nbsp;&nbsp;&nbsp; ' Create and bind the SqlDependency objectto the command object.
&nbsp;&nbsp;&nbsp; dependency = New SqlDependency(cmd)
&nbsp;&nbsp;&nbsp; AddHandler dependency.OnChange, AddressOf DependencyOnChange


&nbsp;&nbsp;&nbsp; ' After register SqlDependency, the SqlCommand must be executed, or we can't 
&nbsp;&nbsp;&nbsp;&nbsp;' get the notification.
&nbsp;&nbsp;&nbsp; RegisterSqlCommand()
End Sub

</pre>
<pre id="codePreview" class="vb">Private Sub RegisterSqlDependency()
&nbsp;&nbsp;&nbsp; If Command Is Nothing OrElse Connection Is Nothing Then
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Throw New ArgumentException(&quot;command and connection cannot be null&quot;)
&nbsp;&nbsp;&nbsp; End If


&nbsp;&nbsp;&nbsp; ' Make sure the command object does not already have
&nbsp;&nbsp;&nbsp; ' a notification object associated with it.
&nbsp;&nbsp;&nbsp; cmd.Notification = Nothing


&nbsp;&nbsp;&nbsp; ' Create and bind the SqlDependency objectto the command object.
&nbsp;&nbsp;&nbsp; dependency = New SqlDependency(cmd)
&nbsp;&nbsp;&nbsp; AddHandler dependency.OnChange, AddressOf DependencyOnChange


&nbsp;&nbsp;&nbsp; ' After register SqlDependency, the SqlCommand must be executed, or we can't 
&nbsp;&nbsp;&nbsp;&nbsp;' get the notification.
&nbsp;&nbsp;&nbsp; RegisterSqlCommand()
End Sub

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
When data was changed, the even handler will be fired.</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>VB</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">vb</span>
<pre class="hidden">Private Sub DependencyOnChange(ByVal sender As Object, ByVal e As SqlNotificationEventArgs)
&nbsp;&nbsp;&nbsp; ' Move the original SqlDependency event handler.
&nbsp;&nbsp;&nbsp; Dim dependency As SqlDependency = CType(sender, SqlDependency)
&nbsp;&nbsp;&nbsp; RemoveHandler dependency.OnChange, AddressOf DependencyOnChange


&nbsp;&nbsp;&nbsp; RaiseEvent OnChanged(Me, Nothing)


&nbsp;&nbsp;&nbsp; ' We re-register the SqlDependency.
&nbsp;&nbsp;&nbsp; RegisterSqlDependency()
End Sub

</pre>
<pre id="codePreview" class="vb">Private Sub DependencyOnChange(ByVal sender As Object, ByVal e As SqlNotificationEventArgs)
&nbsp;&nbsp;&nbsp; ' Move the original SqlDependency event handler.
&nbsp;&nbsp;&nbsp; Dim dependency As SqlDependency = CType(sender, SqlDependency)
&nbsp;&nbsp;&nbsp; RemoveHandler dependency.OnChange, AddressOf DependencyOnChange


&nbsp;&nbsp;&nbsp; RaiseEvent OnChanged(Me, Nothing)


&nbsp;&nbsp;&nbsp; ' We re-register the SqlDependency.
&nbsp;&nbsp;&nbsp; RegisterSqlDependency()
End Sub

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
3. <strong>Regularly Update </strong></p>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
When register the SqlDependency, we create a Threading.Timer and set the delegate, state,delay time, period, and then run it.</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>VB</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">vb</span>
<pre class="hidden">Private Sub RegisterSqlDependency()
&nbsp;&nbsp;&nbsp; If Connection Is Nothing OrElse Command Is Nothing Then
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Throw New ArgumentException(&quot;command and connection cannot be null&quot;)
&nbsp;&nbsp;&nbsp; End If


&nbsp;&nbsp;&nbsp; ' Make sure the command object does not already have
&nbsp;&nbsp;&nbsp; ' a notification object associated with it.
&nbsp;&nbsp;&nbsp; cmd.Notification = Nothing


&nbsp;&nbsp;&nbsp; ' Create and bind the SqlDependency object
&nbsp;&nbsp;&nbsp; ' to the command object.
&nbsp;&nbsp;&nbsp; dependency = New SqlDependency(cmd)
&nbsp;&nbsp;&nbsp; Console.WriteLine(&quot;Id of sqldependency:{0}&quot;, dependency.Id)


&nbsp;&nbsp;&nbsp; RegisterSqlCommand()


&nbsp;&nbsp;&nbsp; timer = New Timer(AddressOf CheckChange, Nothing, 0, interval)
&nbsp;&nbsp;&nbsp; timer.Change(0, interval)
End Sub

</pre>
<pre id="codePreview" class="vb">Private Sub RegisterSqlDependency()
&nbsp;&nbsp;&nbsp; If Connection Is Nothing OrElse Command Is Nothing Then
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Throw New ArgumentException(&quot;command and connection cannot be null&quot;)
&nbsp;&nbsp;&nbsp; End If


&nbsp;&nbsp;&nbsp; ' Make sure the command object does not already have
&nbsp;&nbsp;&nbsp; ' a notification object associated with it.
&nbsp;&nbsp;&nbsp; cmd.Notification = Nothing


&nbsp;&nbsp;&nbsp; ' Create and bind the SqlDependency object
&nbsp;&nbsp;&nbsp; ' to the command object.
&nbsp;&nbsp;&nbsp; dependency = New SqlDependency(cmd)
&nbsp;&nbsp;&nbsp; Console.WriteLine(&quot;Id of sqldependency:{0}&quot;, dependency.Id)


&nbsp;&nbsp;&nbsp; RegisterSqlCommand()


&nbsp;&nbsp;&nbsp; timer = New Timer(AddressOf CheckChange, Nothing, 0, interval)
&nbsp;&nbsp;&nbsp; timer.Change(0, interval)
End Sub

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
Then at the end of period, the delegate will be fired.</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>VB</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">vb</span>
<pre class="hidden">Private Sub CheckChange(ByVal state As Object)
&nbsp;&nbsp;&nbsp; If dependency IsNot Nothing AndAlso dependency.HasChanges Then
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RaiseEvent OnChanged(Me, Nothing)
&nbsp;&nbsp;&nbsp; End If
End Sub

</pre>
<pre id="codePreview" class="vb">Private Sub CheckChange(ByVal state As Object)
&nbsp;&nbsp;&nbsp; If dependency IsNot Nothing AndAlso dependency.HasChanges Then
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RaiseEvent OnChanged(Me, Nothing)
&nbsp;&nbsp;&nbsp; End If
End Sub

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoNormal"><span class="MsoHyperlink"><a href="http://msdn.microsoft.com/query/dev11.query?appId=Dev11IDEF1&amp;l=EN-US&amp;k=k(<a class="libraryLink" href="https://msdn.microsoft.com/en-US/library/System.Data.SqlClient.SqlDependency.aspx"  title="Auto generated link to System.Data.SqlClient.SqlDependency">System.Data.SqlClient.SqlDependency</a>);k(TargetFrameworkMoniker-.NETFramework,Version%3Dv4.5);k(DevLang-csharp)&rd=true">SqlDependency
 Class</a> </span></p>
<p class="MsoNormal"><span class="MsoHyperlink"><a href="http://msdn.microsoft.com/en-us/library/a52dhwx7.aspx">Using SqlDependency in a Windows Application</a>
</span></p>
<p class="MsoNormal"><span class="MsoHyperlink"><a href="http://msdn.microsoft.com/en-us/library/System.Threading.Timer.aspx">Timer Class</a>
</span></p>
<hr>
<div><a href="http://go.microsoft.com/?linkid=9759640" style="margin-top:3px"><img src="description/d8d3630a-6b12-4c82-bad7-865f491df936image.png" alt="">
</a></div>

</div>


    </div>
</body>
</html>
