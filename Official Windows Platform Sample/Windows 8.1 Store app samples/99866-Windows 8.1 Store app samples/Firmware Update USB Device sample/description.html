<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="description/Combined.css,0:HeaderFooterSprite,0:Header.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=C9973DA951AE6202C9B348379A1BE49D" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="description/a7bd86db-8a7a-43ce-8954-21f8f839f51bCombined.css,0:HeaderFooterSprite,0:Footer.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=F576C687BC536B84D6E5B3246EE39B49" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Firmware Update USB Device sample</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" />
        <link href="description/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="description/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>Firmware Update USB Device sample</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            Windows Runtime
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            usb, Devices and sensors
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Windows RT
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary language</label>
                    <div id="LastUpdated">en-US</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Updated</label>
                    <div id="LastUpdated">11/25/2013</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">MS-LPL</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="http://code.msdn.microsoft.com/Firmware-Update-USB-Device-76a6d9ae">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    
<div id="mainSection">
<p>This sample shows how a Windows Store app can update the firmware of a USB device. The update operation runs as a background task. The sample demonstrates the use of the
<a href="http://msdn.microsoft.com/library/windows/apps/dn278466"><b>Windows.Devices.Usb</b></a> namespace.
</p>
<p>To run this sample you need:</p>
<ul>
<li>A SuperMUTT device. You can purchase the device from <a href="http://jjgtechnologies.com/mutt.htm">
JJG Technologies</a>. </li></ul>
<p>
<table>
<tbody>
<tr>
<th>Windows runtime class</th>
<th>Description</th>
</tr>
<tr>
<td>FirmwareUpdate</td>
<td>
<p>The class implements methods that updates firmware in a background process that is separate from the process in which the app runs.
</p>
<ul>
<li>
<p>When the user navigates to MainPage, the app checks whether a background task is already registered. If a task is found, then most likely the app either closed or stopped working. In that case, the app unregisters the previous task.</p>
</li><li>When the user clicks <b>Perform a firmware update on the first available device</b>, the app finds all SuperMUTT devices and gets the
<a href="http://msdn.microsoft.com/library/windows/apps/br225393"><b>DeviceInformation</b></a> object for the first device. The app then attempts to opens the device in order for the consent prompt to be shown to the user. When the user clicks the
<b>Allow</b> button on the consent prompt, the app closes the device (discussed later) and creates and registers a background task for updating the firmware with the trigger. The app also registers its completion and progress routines to get notified about
 the task.
<p class="note"><b>Note</b>&nbsp;&nbsp;A background task cannot show the consent prompt.</p>
</li><li>The background task runs in a separate process. Because only one process can access the device at any given time, the app releases the
<a href="http://msdn.microsoft.com/library/windows/apps/dn263883"><b>UsbDevice</b></a> object so that the background task can open the device for the update operation.
</li><li>The task is canceled if it's not completed within two minutes. </li><li>Every time the task writes a sector of firmware data to the device, the progress callback routine is invoked. Within that callback, the app updates the progress bar. After all sectors are written to the device, the task releases the
<a href="http://msdn.microsoft.com/library/windows/apps/dn263883"><b>UsbDevice</b></a> object.
</li><li>When the background task completes, the completion callback is invoked. Within that callback the app reopens the device so that it can obtain the latest firmware version. It then shows the firmware version information and the status of the update operation
 is displayed. </li></ul>
<p></p>
</td>
</tr>
</tbody>
</table>
</p>
<h2><a id="related_topics"></a>Related topics</h2>
<dl><dt><a href="http://msdn.microsoft.com/library/windows/apps/dn303355">Writing a Windows store app for a USB device</a>
</dt><dt><a href="http://msdn.microsoft.com/library/windows/apps/dn278466"><b>Windows.Devices.Usb</b></a>
</dt></dl>
<h2>Related technologies</h2>
<a href="http://msdn.microsoft.com/library/windows/apps/dn278466"><b>Windows.Devices.Usb</b></a>
<p>Provides Windows Runtime classes and enumerations that a Windows store app can use to communicate with an external USB device that uses WinUSB (Winusb.sys) as the device driver.
</p>
, <a href="http://msdn.microsoft.com/library/windows/apps/br224847"><b>Windows.ApplicationModel.Background</b></a>
<p>Enables an app to schedule background tasks to run app code even when the app is suspended.
</p>
<h2>Operating system requirements</h2>
<table>
<tbody>
<tr>
<th>Client</th>
<td><dt>Windows&nbsp;8.1 </dt></td>
</tr>
<tr>
<th>Server</th>
<td><dt>Windows Server&nbsp;2012&nbsp;R2 </dt></td>
</tr>
</tbody>
</table>
<h2>Build the sample</h2>
<h2><a id="Flash_the_SuperMUTT_device_to_load_the_driver"></a><a id="flash_the_supermutt_device_to_load_the_driver"></a><a id="FLASH_THE_SUPERMUTT_DEVICE_TO_LOAD_THE_DRIVER"></a>Flash the SuperMUTT device to load the driver</h2>
<p>To automatically load Winusb.sys as the device driver: </p>
<ol>
<li>Download and install the <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/jj590752.aspx">
MUTT Software Package</a>. </li><li>Open a command prompt and run the MuttUtil tool included in the package. Use the tool to update the firmware:
<p><code>MuttUtil.exe –forceupdatefirmware</code></p>
</li><li>By using the MuttUtil tool, change the device mode to WinRTUsbPersonality:
<p><code>MuttUtil.exe –SetWinRTUsb</code></p>
<p>The SuperMUTT device when configured in WinRTUsbPersonality mode, exposes configuration, interfaces, and endpoints, that work with the sample.
</p>
</li></ol>
<h2><a id="Building_the_Sample"></a><a id="building_the_sample"></a><a id="BUILDING_THE_SAMPLE"></a>Building the Sample</h2>
<p>To build this sample, open the solution (.sln) file titled FirmwareUpdateUsbDevice.sln from Microsoft Visual Studio&nbsp;2013. Press F7 or go to
<b>Build</b>-&gt;<b>Build Solution</b> from the top menu after the sample has loaded.</p>
<h2>Run the sample</h2>
<ol>
<li>Update the device metadata to indicate that the sample is a privileged app.
<p><img src="description/image.png" alt="" align="middle">
</p>
</li><li>Open the <b>Finish</b> tab. Select the <b>Copy packages to your system's local metadata store</b> check box.
<p class="note"><b>Note</b>&nbsp;&nbsp;Alternatively, you can copy the metadata manually to %PROGRAMDATA%/Microsoft/Windows/DeviceMetadataStore.</p>
</li><li>Connect the device to the computer. </li><li>In Control Panel, open <b>View devices and printers</b> and verify that the icon of the device is this image:
<p><img src="description/0c80713e-c85b-487b-92c3-a21e0321032bimage.png" alt="" align="middle">
</p>
</li><li>Verify that the device description is: <b>Device Metadata Package Sample for SuperMUTT</b>.
</li><li>View the properties. Notice that the description specifies the specific sample associated in the device metadata. For example, for the C&#43;&#43; sample, the description shows
<b>To be used for Updating Firmware with C&#43;&#43; sample</b>. This string is useful for identifying the sample when you are running JavaScript, C#/VB.NET samples simultaneously.
</li><li>To run this sample after building it, press F5 (run with debugging enabled) or Ctrl-F5 (run without debugging enabled), or select the corresponding options from the
<b>Debug</b> menu. To deploy the app, select <b>Build</b> &gt; <b>Deploy FirmwareUpdateUsbDevice</b>.
<p class="note"><b>Note</b>&nbsp;&nbsp;The first time you run the sample, you will be prompted whether you allow the app to use the USB device. Choose
<b>Allow</b> to proceed.</p>
</li><li>Click <b>Perform a firmware update on the first available</b> device to start updating the device.
</li><li>View the progress of the operation. </li><li>When the output string shows <b>Firmware update completed</b>, verify that the
<b>Firmware version after firmware update</b> shows the correct version. </li><li>To cancel the update, click <b>Cancel firmware update</b>. </li></ol>
<p><img src="description/25471aae-8f7b-4dc6-a9b9-0b2bae4df855image.png" alt="" align="middle">
</p>
<h2><a id="Known_issue"></a><a id="known_issue"></a><a id="KNOWN_ISSUE"></a>Known issue</h2>
<p><b>Applies to C&#43;&#43; and C# samples</b>: The app might unexpectedly terminate when the user tries to cancel a firmware update request that is in progress.</p>
<p>Each time the sample app initiates a request to update the device firmware, the app starts a background task. As the task runs, it first waits for approximately 30 seconds while the device prepares itself for the update (implemented with a
<b>Concurrency::wait</b> call in <b>SetupDeviceForFirmwareUpdateAsync</b>). During that time, the progress bar does not move.</p>
<p>If the user cancels the request during the 30-second period, the app cannot cancel the background task because of the
<b>wait</b> call. Because there is a system-imposed time limit on completing tasks when they are canceled, the system terminates the background task and the app closes.</p>
<p>To avoid that unexpected termination, replace all <b>Concurrency::wait</b> methods in the sample with this
<b>Wait</b> implementation. Make sure you call <b>Wait().get()</b> to allow any cancellation exception to propagate through the task chain.
</p>
<p>The following workaround is suggested for C&#43;&#43; apps. </p>
<div class="code"><span>
<table>
<tbody>
<tr>
<th>C&#43;&#43;</th>
</tr>
<tr>
<td>
<pre>/// &lt;summary&gt;
/// Waits for a caller specified time, but it checks every second to determine whether the task was canceled.
///
/// Must call Wait().get() to propagate the canceled exception.
///
/// If the background task is canceled, the task must be completed within a certain amount of time
/// (See &quot;How to handle idle or hung background tasks&quot; in MSDN). Otherwise, the
/// system terminates the background task and the app.
///
/// In order to complete the task within the system-imposed time limit, the background task cannot wait for too long.
/// This implementation waits and checks whether the task was canceled in small intervals to prevent a long wait. 
/// &lt;/summary&gt;
/// &lt;param name=&quot;millisecondsToWait&quot;&gt;&lt;/param&gt;
task&lt;void&gt; UpdateFirmwareTask::Wait(uint32 millisecondsToWait)
{
    return task&lt;void&gt;([millisecondsToWait] ()
    {
        uint32 timeLeftToWait = millisecondsToWait;

        // Split waits so that the background task does not wait more than the specified amount of time
        while (timeLeftToWait &gt; 0)
        {
            if (is_task_cancellation_requested())
            {
                cancel_current_task();
            }

            uint32 timeToWait = 0;

            if (timeLeftToWait &gt; FirmwareUpdateTaskInformation::MaxWaitTimeBetweenCancellationChecks)
            {
                timeToWait = FirmwareUpdateTaskInformation::MaxWaitTimeBetweenCancellationChecks;
            }
            else
            {
                timeToWait = timeLeftToWait;
            }

            wait(timeToWait);

            timeLeftToWait -= timeToWait;
        }

     }, cancellationTokenSource.get_token());
}
</pre>
</td>
</tr>
</tbody>
</table>
</span></div>
<p>The following workaround is suggested for C# apps. When calling <b>Task.Delay</b>, include a cancellation token as an argument, as shown here:</p>
<div class="code"><span>
<table>
<tbody>
<tr>
<th>C#</th>
</tr>
<tr>
<td>
<pre>
await Task.Delay(30000, cancellationTokenSource.Token);  

</pre>
</td>
</tr>
</tbody>
</table>
</span></div>
</div>

</div>


    </div>
</body>
</html>
