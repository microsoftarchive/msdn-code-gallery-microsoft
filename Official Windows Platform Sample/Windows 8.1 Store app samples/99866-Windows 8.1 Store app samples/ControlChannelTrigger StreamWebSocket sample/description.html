<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="description/Combined.css,0:HeaderFooterSprite,0:Header.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=C9973DA951AE6202C9B348379A1BE49D" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="description/67b74b86-a273-4ad7-9ed5-0f97276412eaCombined.css,0:HeaderFooterSprite,0:Footer.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=F576C687BC536B84D6E5B3246EE39B49" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>ControlChannelTrigger StreamWebSocket sample</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" />
        <link href="description/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="description/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>ControlChannelTrigger StreamWebSocket sample</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            Windows Runtime
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            Networking
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Windows RT
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary language</label>
                    <div id="LastUpdated">en-US</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Updated</label>
                    <div id="LastUpdated">11/25/2013</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">MS-LPL</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="http://code.msdn.microsoft.com/ControlChannelTrigger-91f6bed8">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    
<div id="mainSection">
<p>The sample shows how to use the <a href="http://msdn.microsoft.com/library/windows/apps/hh701032">
<b>ControlChannelTrigger</b></a> class to enable a Windows Store app using a <a href="http://msdn.microsoft.com/library/windows/apps/br226923">
<b>StreamWebSocket</b></a> to be always connected and always reachable. This sample demonstrates the use of background network notifications in a Windows Store app.
</p>
<p>The <a href="http://msdn.microsoft.com/library/windows/apps/hh701032"><b>ControlChannelTrigger</b></a> class and related interfaces are used to enable real-time network status and triggers for class elements in the
<a href="http://msdn.microsoft.com/library/windows/apps/br226960"><b>Windows.Networking.Sockets</b></a> and related namespaces. These features allow an app to receive notifications while the app is suspended. These notifications can be set to occur when network
 packets are received or to maintain keep-alive packets. This sample uses notifications to receive incoming network packets and maintain keep-alive packets. This allows the app to minimize power usage for improved battery life and wake up to respond to incoming
 packets and other conditions only when needed. </p>
<p>The <a href="http://msdn.microsoft.com/library/windows/apps/hh701032"><b>ControlChannelTrigger</b></a> class is commonly used by long-running network apps to minimize network and system resource usage (an email app that is left running, for example). Network
 triggers allow an app to drop to a low-power mode for periods of time while still keeping established network connections intact and operating in a low-power state. An app can set a server keep-alive interval used by the system for when the app should wake
 up. An app can also set a trigger to wake up when network data is received by the system for the app.
</p>
<p>A Windows Store app for Windows&nbsp;8.1 is normally suspended when it is no longer in the foreground app and moved to the background. There are some exceptions to suspending an app (actively printing, accessing an audio stream, and transferring files in the
 background, for example). The <a href="http://msdn.microsoft.com/library/windows/apps/hh701032">
<b>ControlChannelTrigger</b></a> class allows a network app that has established a TCP connection to notify the system that an established network connection should be kept operational and the system should wake up the suspended app when network data is received
 for the app or the server keep-alive timer interval expires. </p>
<p>In this sample, the <a href="http://msdn.microsoft.com/library/windows/apps/hh701032">
<b>ControlChannelTrigger</b></a> class is used with the <a href="http://msdn.microsoft.com/library/windows/apps/br226923">
<b>StreamWebSocket</b></a> class to connect to web server that supports WebSockets. However, the
<b>ControlChannelTrigger</b> class can also be used with other network transports that establish a TCP connection.</p>
<p>The <a href="http://msdn.microsoft.com/library/windows/apps/hh701032"><b>ControlChannelTrigger</b></a> class can be used with instances of the following classes in the
<a href="http://msdn.microsoft.com/library/windows/apps/br226960"><b>Windows.Networking.Sockets</b></a> that establish a TCP connection.
</p>
<p></p>
<ul>
<li><a href="http://msdn.microsoft.com/library/windows/apps/br226842"><b>MessageWebSocket</b></a>
</li><li><a href="http://msdn.microsoft.com/library/windows/apps/br226923"><b>StreamWebSocket</b></a>
</li><li><a href="http://msdn.microsoft.com/library/windows/apps/br226882"><b>StreamSocket</b></a>
</li></ul>
<p></p>
<p>The <a href="http://msdn.microsoft.com/library/windows/apps/hh701032"><b>ControlChannelTrigger</b></a> class can also be used by instances of the following that establish a TCP connection:</p>
<p></p>
<ul>
<li>The <a href="http://msdn.microsoft.com/library/windows/apps/dn298639"><b>HttpClient</b></a> class in the
<a href="http://msdn.microsoft.com/library/windows/apps/dn279692"><b>Windows.Web.Http</b></a> namespace.
</li><li>The <a href="http://msdn.microsoft.com/library/windows/apps/hh831151"><b>IXMLHTTPRequest2</b></a> interface that extends the
<b>IXmlHttpRequest</b> interface defined in several working drafts published by the World Wide Web Consortium (W3C).
</li></ul>
<p></p>
<p></p>
<p class="note"><b>Note</b>&nbsp;&nbsp;The <a href="http://msdn.microsoft.com/library/windows/apps/hh701032">
<b>ControlChannelTrigger</b></a> class is not supported in a Windows Store app built for Windows using JavaScript.
</p>
<p></p>
<p>Versions of this sample are provided in both C# and C&#43;&#43;. This sample requires some experience with network programming.
</p>
<p>This sample requires the following capabilities:</p>
<ul>
<li><b>Home or work networking</b> - Needed when WebSocket requests are sent to servers on a home or work intranet.
</li></ul>
<p></p>
<p>To obtain an evaluation copy of Windows&nbsp;8.1, go to <a href="http://go.microsoft.com/fwlink/p/?linkid=301696">
Windows&nbsp;8.1</a>.</p>
<p>To obtain an evaluation copy of Microsoft Visual Studio&nbsp;2013, go to <a href="http://go.microsoft.com/fwlink/p/?linkid=301697">
Visual Studio&nbsp;2013</a>.</p>
<p></p>
<p class="note"><b>Note</b>&nbsp;&nbsp;For Windows&nbsp;8 app samples, download the <a href="http://go.microsoft.com/fwlink/p/?LinkId=301698">
Windows&nbsp;8 app samples pack</a>. The samples in the Windows&nbsp;8 app samples pack will build and run only on Microsoft Visual Studio&nbsp;2012.</p>
<p></p>
<h2><a id="related_topics"></a>Related topics</h2>
<dl><dt><b>Other resources</b> </dt><dt><a href="http://msdn.microsoft.com/library/windows/apps/hh452752">Adding support for networking</a>
</dt><dt><a href="http://msdn.microsoft.com/library/windows/apps/hh761442">Connecting to a WebSocket service</a>
</dt><dt><a href="http://msdn.microsoft.com/library/windows/apps/hh770532">How to configure network isolation capabilities</a>
</dt><dt><a href="http://msdn.microsoft.com/library/windows/apps/hh771189">How to set background connectivity options</a>
</dt><dt><a href="http://msdn.microsoft.com/library/windows/apps/hh977056">Supporting your app with background tasks</a>
</dt><dt><b>Reference</b> </dt><dt><a href="http://msdn.microsoft.com/library/windows/apps/hh701032"><b>ControlChannelTrigger</b></a>
</dt><dt><a href="http://msdn.microsoft.com/library/windows/apps/br226923"><b>StreamWebSocket</b></a>
</dt><dt><a href="http://msdn.microsoft.com/library/windows/apps/br226960"><b>Windows.Networking.Sockets</b></a>
</dt><dt><b>Samples</b> </dt><dt><a href="http://go.microsoft.com/fwlink/p/?linkid=258323">ControlChannelTrigger HttpClient sample</a>
</dt><dt><a href="http://go.microsoft.com/fwlink/p/?linkid=258538">ControlChannelTrigger IXMLHTTPRequest2 sample</a>
</dt><dt><a href="http://go.microsoft.com/fwlink/p/?linkid=243039">ControlChannelTrigger StreamSocket sample</a>
</dt><dt><a href="http://go.microsoft.com/fwlink/p/?linkid=239964">Connecting with WebSockets sample</a>
</dt><dt><a href="http://go.microsoft.com/fwlink/p/?LinkID=227694">Windows 8 app samples</a>
</dt></dl>
<h2>Operating system requirements</h2>
<table>
<tbody>
<tr>
<th>Client</th>
<td><dt>Windows&nbsp;8.1 </dt></td>
</tr>
<tr>
<th>Server</th>
<td><dt>Windows Server&nbsp;2012&nbsp;R2 </dt></td>
</tr>
</tbody>
</table>
<h2>Build the sample</h2>
<ol>
<li>Start Visual Studio&nbsp;2013 and select <b>File</b> &gt; <b>Open</b> &gt; <b>Project/Solution</b>.
</li><li>Go to the directory in which you unzipped the sample. Go to the directory named for the sample, and double-click the Visual Studio&nbsp;2013 Solution (.sln) file.
</li><li>Press F7 or use <b>Build</b> &gt; <b>Build Solution</b> to build the sample. </li></ol>
<h2>Run the sample</h2>
<p>This sample requires that a web server that supports WebSockets is available on a separate computer for the app to access for sending requests and receiving responses. The web server must be started before the app is run. The web server must also have a
<i>WebSocketSample</i> path available for the <i>EchoWebSocket.ashx</i> file. The sample includes a PowerShell script that will install IIS on a computer, create the
<i>WebSocketSample</i> folder on the server, and copy files to this folder. </p>
<p>The easiest way to run the sample is to use the provided web server scripts. Browse to the
<i>Server</i> folder in your sample folder to setup and start the web server. Copy this folder and its subfolder to another computer and run the server scripts. There are two options possible.</p>
<p></p>
<ul>
<li>Start PowerShell elevated (Run as administrator) and run the following command:
<p><b>.\SetupServer.ps1</b></p>
<p>Note that you may also need to change script execution policy. </p>
</li><li>Start an elevated Command Prompt (Run as administrator) and run following command:
<p><b>PowerShell.exe -ExecutionPolicy Unrestricted -File SetupServer.ps1</b></p>
</li></ul>
<p></p>
<p>When the web server is not needed anymore, please browse to the copy of the <i>
Server</i> folder on the computer and run one of the following:</p>
<p></p>
<ul>
<li>Start PowerShell elevated (Run as administrator) and run the following command:
<p><b>.\RemoveServer.ps1</b></p>
<p>Note that you may also need to change script execution policy. </p>
</li><li>Start an elevated Command Prompt (Run as administrator) and run following command:
<p><b>PowerShell.exe -ExecutionPolicy Unrestricted -File RemoveServer.ps1</b></p>
</li></ul>
<p></p>
<p>To configure the app for use with the web server:</p>
<ul>
<li>Additional capabilities may need to be added. For example, &quot;Internet (Client)&quot; if the web server is located on the Internet and not on a local home or work network.
</li><li>The target ServerUri field should be updated. This is changed by editing the XAML files so that the Server-HostName TextBox contains the URI to the web server.
</li></ul>
<p></p>
<p>The sample can run using any web server, not only the one provided with the sample. In this case, running the previous scripts is not required. However, this requires some special configuration of the server to create the
<i>Server</i> folder and copy files to this folder. </p>
<p>To configure for use with a different web server:</p>
<dl><dd>Copy the <i>Server\webSite</i> directory to the <i>WebSocketSample</i> folder on the web server and configure the server to support WebSockets. Also configure the web server so it delays responses by about 25 seconds. This delay is to ensure the client
 app can have enough time to enter suspended state and then receive the incoming response from the server.
</dd><dd>Revise or replace the <i>EchoWebSocket.ashx</i> file as need so it works with the web server.
</dd></dl>
<p class="note"><b>Note</b>&nbsp;&nbsp;IIS is not available on ARM builds. Instead, set up the web server on a separate 64-bit or x86 32-bit computer.
</p>
<p class="note"><b>Note</b>&nbsp;&nbsp;When used with the supplied scripts, this Windows Store app sample communicates with another process (IIS server which is a desktop app) on the same machine over loopback for demonstration purposes only. A Windows Store app that
 communicates over loopback to another process that represents a Windows Store app is not allowed and such apps will not pass Store validation. For more information, see
<a href="http://msdn.microsoft.com/library/windows/apps/hh770532">How to configure network isolation capabilities</a>.
</p>
<p></p>
<p>To deploy this app after building it, select <b>Deploy Solution</b> from the <b>
Build</b> menu. A tile for the sample will be available on the Start Screen. To both deploy and run the sample, press F5 (run with debugging enabled) or Ctrl&#43;F5 (run without debugging enabled) from Visual Studio&nbsp;2013 (any SKU). (Or select the corresponding
 options from the Debug menu.) </p>
<p>After the server computer has started, start the app on the local computer. </p>
<dl><dd>A tile to start the app will be available on the Start Screen. </dd></dl>
<p></p>
<p>Once the client starts, the <b>Connect</b> button should establish a WebSocket connection and the
<b>Send</b> button will send a request to the web server. The response from the web server will delayed so the app will have time to be suspended. The resulting delayed WebSocket response will be received by the
<a href="http://msdn.microsoft.com/library/windows/apps/hh701032"><b>ControlChannelTrigger</b></a> and a toast will be displayed.
</p>
<p class="note"><b>Note</b>&nbsp;&nbsp;When the app is run under a debugger, it will not be suspended.</p>
<p></p>
</div>

</div>


    </div>
</body>
</html>
